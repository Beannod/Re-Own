<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Sign Up - Re-Own</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="css/auth.css" />
    <link rel="stylesheet" href="css/landing.css" />
    <style>
        body { min-height: 100vh; background: linear-gradient(135deg, #74ABE2, #5563DE); }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; } </style>
    <link rel="icon" href="assets/favicon.ico" />
    <meta name="theme-color" content="#5563DE" />
    <meta name="description" content="Re-Own login and sign up" />
</head>
<body>
    <!-- Shared Header / Nav from landing page -->
    <nav id="nav" class="navbar navbar-expand-lg navbar-light fixed-top nav-transparent">
        <div class="container">
            <a class="navbar-brand fw-bold" href="landing.html#home">
                <i class="fa-solid fa-house-chimney me-2"></i> Re-Own
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><a class="nav-link" href="landing.html#home">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="landing.html#features">Features</a></li>
                    <li class="nav-item"><a class="nav-link" href="landing.html#how">How It Works</a></li>
                    <li class="nav-item"><a class="nav-link" href="landing.html#pricing">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="landing.html#contact">Contact</a></li>
                    <li class="nav-item ms-lg-3"><a class="btn btn-brand" href="#register" onclick="event.preventDefault(); window.location.hash='#register'">Sign Up</a></li>
                    <li class="nav-item ms-2"><a class="btn btn-outline-brand" href="#login" onclick="event.preventDefault(); window.location.hash='#login'">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div id="login" class="container d-flex align-items-center justify-content-center" style="min-height:100vh;">
        <div class="auth-card shadow-lg rounded-4 bg-white p-4 p-md-5" style="width:100%; max-width: 480px;">
            <div class="text-center mb-4">
                <div class="h3 fw-bold mb-1"><i class="fa-solid fa-house-chimney me-2 text-primary"></i>Re-Own</div>
                <div class="text-muted">Welcome back — sign in or create your account</div>
            </div>

                <!-- Removed obsolete login page logout footer: sign out available via SweetAlert dialog when already authenticated -->

            <!-- Login Form (default visible) -->
            <div id="login-panel" class="auth-panel">
                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email</label>
                        <input type="email" id="login-email" class="form-control form-control-lg rounded-3" required />
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="login-password" class="form-control form-control-lg rounded-start-3" required />
                            <button class="btn btn-outline-secondary toggle-password rounded-end-3" type="button" data-target="#login-password"><i class="fa-regular fa-eye"></i></button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-3">Login</button>
                </form>
                <div class="text-center mt-3 text-muted">
                    Don’t have an account?
                    <a href="#register" class="toggle-auth" data-switch="register">Sign Up</a>
                </div>
                <div class="text-center mt-3">
                    <a href="landing.html" class="link-secondary small">Learn more about Re-Own</a>
                </div>
            </div>

            <!-- Register Form (hidden initially) -->
            <div id="register-panel" class="auth-panel d-none">
                <form id="register-form">
                    <div class="mb-3">
                        <label for="register-email" class="form-label">Email</label>
                        <input type="email" id="register-email" class="form-control form-control-lg rounded-3" required />
                    </div>
                    <div class="mb-3">
                        <label for="register-username" class="form-label">Username</label>
                        <input type="text" id="register-username" class="form-control form-control-lg rounded-3" required />
                    </div>
                    <div class="mb-3">
                        <label for="register-fullname" class="form-label">Full Name</label>
                        <input type="text" id="register-fullname" class="form-control form-control-lg rounded-3" required />
                    </div>
                    <div class="mb-3">
                        <label for="register-role" class="form-label">Role</label>
                        <select id="register-role" class="form-select form-select-lg rounded-3" required>
                            <option value="owner">Owner</option>
                            <option value="renter">Renter</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="register-password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="register-password" class="form-control form-control-lg rounded-start-3" required />
                            <button class="btn btn-outline-secondary toggle-password rounded-end-3" type="button" data-target="#register-password"><i class="fa-regular fa-eye"></i></button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg w-100 rounded-3">Create Account</button>
                </form>
                <div class="text-center mt-3 text-muted">
                    Already have an account?
                    <a href="#login" class="toggle-auth" data-switch="login">Login</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/error-logger.js"></script>
    <script src="js/landing.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/util.js"></script>
    <script src="js/api.js"></script>
    <!-- Temporary test token injector: visit login.html?testToken=1 or login.html#autotest -->
    <script>
        (function(){
            try {
                const shouldInject = window.location.search.includes('testToken=1') || window.location.hash.includes('autotest');
                if (!shouldInject) return;
                // Ensure CONFIG is available
                if (typeof CONFIG === 'undefined' || !CONFIG.TOKEN_KEY) {
                    console.warn('CONFIG not ready; test token injection skipped');
                    return;
                }

                function b64url(obj) {
                    const s = JSON.stringify(obj);
                    return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                }

                const header = { alg: 'none', typ: 'JWT' };
                const payload = {
                    user_id: 1,
                    role: 'owner',
                    sid: 'test-session',
                    exp: Math.floor(Date.now() / 1000) + 3600
                };
                const token = `${b64url(header)}.${b64url(payload)}.`; // unsigned
                localStorage.setItem(CONFIG.TOKEN_KEY, token);
                console.info('[TEST TOKEN] Injected test token for local testing:', token);
            } catch (e) {
                console.error('Failed to inject test token', e);
            }
        })();
    </script>
    <script src="js/auth.js"></script>
    <script src="js/error-collector.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Auth.init();
        });
    </script>
    <script>
        // Autotest runner (only when ?autotest= is present). This will programmatically
        // exercise the 'Already Signed In' dialog choices: confirm (dashboard), deny (sign out), switch (inline link).
        (function(){
            try {
                const params = new URLSearchParams(window.location.search);
                const mode = params.get('autotest');
                if (!mode) return;

                const actions = (mode === 'all') ? ['confirm','deny','switch'] : [mode];

                // Helper: safely override navigation to capture targets instead of navigating
                try {
                    window.__test_nav = null;
                    const loc = window.location;
                    try { loc.__orig_assign = loc.assign; loc.assign = function(u){ window.__test_nav = u; console.log('[autotest] captured assign ->', u); }; } catch(e){console.warn('assign override failed', e);} 
                    try { loc.__orig_replace = loc.replace; loc.replace = function(u){ window.__test_nav = u; console.log('[autotest] captured replace ->', u); }; } catch(e){console.warn('replace override failed', e);} 
                    try { Object.defineProperty(loc, 'href', { set: function(u){ window.__test_nav = u; console.log('[autotest] captured href ->', u); }, configurable: true }); } catch(e){ console.warn('href setter override failed', e); }
                } catch (e) { console.warn('Navigation overrides failed', e); }

                // Stub API.logout to avoid network dependency
                if (window.API && typeof window.API.logout === 'function') {
                    window.__orig_api_logout = window.API.logout;
                    window.API.logout = async function(){ console.log('[autotest] stubbed API.logout'); return { ok: true }; };
                }

                async function runAction(action){
                    // Ensure token is present before each run
                    if (typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY) {
                        // reuse earlier injected token if present, otherwise inject a test token
                        if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
                            const header = { alg: 'none', typ: 'JWT' };
                            const payload = { user_id:1, role:'owner', sid:'test-session', exp: Math.floor(Date.now()/1000) + 3600 };
                            function b64url(obj){ return btoa(JSON.stringify(obj)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
                            localStorage.setItem(CONFIG.TOKEN_KEY, `${b64url(header)}.${b64url(payload)}.`);
                        }
                    }

                    window.__test_nav = null;
                    console.log('[autotest] running action', action);

                    // Trigger the dialog by calling Auth.checkAuthStatus() directly (it's async)
                    try {
                        await Auth.checkAuthStatus();
                    } catch (e) { console.warn('[autotest] checkAuthStatus error', e); }

                    // Wait for Swal popup
                    let attempts = 0;
                    while (!window.Swal || !Swal.getPopup()) {
                        await new Promise(r => setTimeout(r, 150));
                        attempts++;
                        if (attempts > 40) { console.warn('[autotest] popup not found'); break; }
                    }

                    await new Promise(r => setTimeout(r, 200));

                    try {
                        if (action === 'confirm') {
                            if (Swal.clickConfirm) Swal.clickConfirm();
                            else if (Swal.getConfirmButton) Swal.getConfirmButton().click();
                        } else if (action === 'deny') {
                            if (Swal.clickDeny) Swal.clickDeny();
                            else if (Swal.getDenyButton) Swal.getDenyButton().click();
                        } else if (action === 'switch') {
                            // Click the inline 'switch account' link if present
                            const link = document.getElementById('sw-switch-account');
                            if (link) link.click();
                            else if (Swal.getPopup()) {
                                // try to query inside popup
                                const popup = Swal.getPopup();
                                const a = popup.querySelector('#sw-switch-account');
                                if (a) a.click();
                            }
                        }
                    } catch (e) { console.warn('[autotest] click failed', e); }

                    // Wait for potential handlers to run
                    await new Promise(r => setTimeout(r, 400));

                    const result = {
                        action,
                        capturedNavigation: window.__test_nav,
                        tokenPresent: !!(typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY && localStorage.getItem(CONFIG.TOKEN_KEY)),
                    };
                    console.log('[autotest] result', result);
                    return result;
                }

                (async () => {
                    const results = [];
                    for (const a of actions) {
                        // ensure token present before each scenario
                        if (typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY) {
                            // leave existing token if present
                            if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
                                const header = { alg: 'none', typ: 'JWT' };
                                const payload = { user_id:1, role:'owner', sid:'test-session', exp: Math.floor(Date.now()/1000) + 3600 };
                                function b64url(obj){ return btoa(JSON.stringify(obj)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
                                localStorage.setItem(CONFIG.TOKEN_KEY, `${b64url(header)}.${b64url(payload)}.`);
                            }
                        }
                        const r = await runAction(a);
                        results.push(r);

                        // Restore token if the action removed it (e.g. deny/switch)
                        if (typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY && !localStorage.getItem(CONFIG.TOKEN_KEY)) {
                            const header = { alg: 'none', typ: 'JWT' };
                            const payload = { user_id:1, role:'owner', sid:'test-session', exp: Math.floor(Date.now()/1000) + 3600 };
                            function b64url(obj){ return btoa(JSON.stringify(obj)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
                            localStorage.setItem(CONFIG.TOKEN_KEY, `${b64url(header)}.${b64url(payload)}.`);
                        }
                        // small delay between actions
                        await new Promise(r => setTimeout(r, 300));
                    }

                    console.log('[autotest] all results', results);
                    alert('Autotest completed. Check console for detailed results.');

                    // Restore original API.logout if stubbed
                    if (window.__orig_api_logout) window.API.logout = window.__orig_api_logout;
                })();
            } catch (e) { console.error('Autotest runner failed', e); }
        })();
    </script>
    <!-- Dev Test Controls Panel (visible when ?dev=1) -->
    <script>
        (function(){
            try {
                const params = new URLSearchParams(window.location.search);
                const dev = params.get('dev');
                if (!dev || dev !== '1') return;

                // Create panel
                const panel = document.createElement('div');
                panel.style.position = 'fixed';
                panel.style.right = '12px';
                panel.style.top = '12px';
                panel.style.zIndex = '99999';
                panel.style.background = 'rgba(255,255,255,0.95)';
                panel.style.border = '1px solid #ddd';
                panel.style.padding = '8px';
                panel.style.borderRadius = '8px';
                panel.style.width = '220px';
                panel.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';

                const title = document.createElement('div');
                title.style.fontSize = '13px';
                title.style.fontWeight = '600';
                title.style.marginBottom = '6px';
                title.textContent = 'DEV Test Controls';
                panel.appendChild(title);

                function addButton(text, onClick) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-secondary';
                    btn.style.display = 'block';
                    btn.style.width = '100%';
                    btn.style.marginBottom = '6px';
                    btn.textContent = text;
                    btn.addEventListener('click', onClick);
                    panel.appendChild(btn);
                    return btn;
                }

                // Token helpers
                function b64url(obj){ return btoa(JSON.stringify(obj)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
                function injectToken(role){
                    try {
                        if (typeof CONFIG === 'undefined' || !CONFIG.TOKEN_KEY) {
                            console.warn('CONFIG not available');
                            return;
                        }
                        const header = { alg: 'none', typ: 'JWT' };
                        const payload = { user_id: 999, role: role, sid: 'dev-session-'+role, exp: Math.floor(Date.now()/1000) + 3600 };
                        const token = `${b64url(header)}.${b64url(payload)}.`;
                        localStorage.setItem(CONFIG.TOKEN_KEY, token);
                        console.info('[DEV] Injected token for role:', role);
                        alert('Injected ' + role + ' token');
                    } catch (e) { console.error('injectToken failed', e); }
                }

                function clearToken(){
                    try { if (typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY) localStorage.removeItem(CONFIG.TOKEN_KEY); alert('Cleared token'); } catch(e){console.error(e);} }

                // Autotest trigger: call the existing autotest runner by setting hash and reloading,
                // or call Auth.checkAuthStatus to open the dialog and then simulate clicks.
                async function runAutotest(mode){
                    try {
                        // ensure token exists
                        if (typeof CONFIG !== 'undefined' && CONFIG.TOKEN_KEY && !localStorage.getItem(CONFIG.TOKEN_KEY)) {
                            injectToken('owner');
                        }

                        // Call Auth.checkAuthStatus to open dialog
                        if (window.Auth && typeof Auth.checkAuthStatus === 'function') {
                            await Auth.checkAuthStatus();

                            // Wait briefly for popup
                            await new Promise(r => setTimeout(r, 200));

                            if (!window.Swal || !Swal.getPopup()) {
                                console.warn('Popup not found');
                                return;
                            }

                            if (mode === 'confirm') {
                                if (Swal.clickConfirm) Swal.clickConfirm(); else (Swal.getConfirmButton() && Swal.getConfirmButton().click());
                            } else if (mode === 'deny') {
                                if (Swal.clickDeny) Swal.clickDeny(); else (Swal.getDenyButton() && Swal.getDenyButton().click());
                            } else if (mode === 'switch') {
                                const a = document.getElementById('sw-switch-account') || (Swal.getPopup() && Swal.getPopup().querySelector('#sw-switch-account'));
                                if (a) a.click(); else console.warn('Switch link not found');
                            } else if (mode === 'all') {
                                // sequence: confirm, then restore token, then deny, then restore, then switch
                                await runAutotest('confirm');
                                await new Promise(r => setTimeout(r,300));
                                // restore token
                                injectToken('owner');
                                await runAutotest('deny');
                                await new Promise(r => setTimeout(r,300));
                                injectToken('owner');
                                await runAutotest('switch');
                            }
                        } else {
                            // fallback: navigate to self with autotest param
                            const url = window.location.href.split('?')[0] + '?testToken=1&autotest=' + encodeURIComponent(mode);
                            window.location.href = url;
                        }
                    } catch (e) { console.error('runAutotest failed', e); }
                }

                addButton('Inject Owner Token', () => injectToken('owner'));
                addButton('Inject Renter Token', () => injectToken('renter'));
                addButton('Clear Token', clearToken);
                addButton('Autotest: Confirm', () => runAutotest('confirm'));
                addButton('Autotest: Deny(Sign Out)', () => runAutotest('deny'));
                addButton('Autotest: Switch', () => runAutotest('switch'));
                addButton('Autotest: All', () => runAutotest('all'));

                document.addEventListener('DOMContentLoaded', () => document.body.appendChild(panel));
                // expose for console usage
                window.__dev_injectToken = injectToken;
                window.__dev_clearToken = clearToken;
                window.__dev_runAutotest = runAutotest;
            } catch (e) { console.error('Dev panel failed', e); }
        })();
    </script>
</body>
</html>
